<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Search the Train Simulator Mod Archive for delisted and lost Train Simulator Classic content.">
    <meta name="keywords" content="train simulator, mods, archive, truRail, clearTracks, UTS creations, east coast simulations">
    <title>Search - Train Simulator Mod Archive</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/jpeg" href="https://files.trainsimarchive.org/media/favicon.jpg">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.trainsimarchive.org/search.html">
    <meta property="og:title" content="Search">
    <meta property="og:description" content="Search the Train Simulator Mod Archive for delisted and lost Train Simulator Classic content.">
    <meta property="og:image" content="https://files.trainsimarchive.org/media/tsma-logo.png">
    <meta property="og:site_name" content="Train Simulator Mod Archive">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://www.trainsimarchive.org/search.html">
    <meta property="twitter:title" content="Search">
    <meta property="twitter:description" content="Search the Train Simulator Mod Archive for delisted and lost Train Simulator Classic content.">
    <meta property="twitter:image" content="https://files.trainsimarchive.org/media/tsma-logo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://files.trainsimarchive.org/media/tsma-logo.png" as="image">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/custom-dark.css" rel="stylesheet">
</head>
<body class="body-with-fixed-header">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <img src="https://files.trainsimarchive.org/media/tsma-logo.png" alt="Train Simulator Mod Archive" class="logo">
            </a>
            <div class="collapse navbar-collapse desktop-nav" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="contributors.html">Contributors</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="archiveDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Archive
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="archiveDropdown">
                            <li><a class="dropdown-item" href="trurail-simulations.html">TruRail Simulations</a></li>
                            <li><a class="dropdown-item" href="cleartracks.html">ClearTracks</a></li>
                            <li><a class="dropdown-item" href="uts-creations.html">UTS Creations</a></li>
                            <li><a class="dropdown-item" href="east-coast-simulations.html">East Coast Simulations</a></li>
                            <li><a class="dropdown-item" href="virtual-rail-creations.html">Virtual Rail Creations</a></li>
                        </ul>
                    </li>
                </ul>
                
                <div class="d-flex align-items-center ms-auto">
                    <input type="text" placeholder="Search..." class="search-input desktop-search" id="searchInput">
                </div>
            </div>
            <button class="mobile-menu-btn" id="mobileMenuBtn">
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
            </button>
        </div>
    </nav>
    <nav class="mobile-nav" id="mobileNav">
        <div class="mobile-nav-content">
            <input type="text" placeholder="Search..." class="search-input mobile-search" id="mobileSearchInput">
            <a href="index.html" class="mobile-nav-link">Home</a>
            <a href="contributors.html" class="mobile-nav-link">Contributors</a>
            <div class="mobile-nav-divider">Archive</div>
            <a href="trurail-simulations.html" class="mobile-nav-link mobile-nav-sublink">TruRail Simulations</a>
            <a href="cleartracks.html" class="mobile-nav-link mobile-nav-sublink">ClearTracks</a>
            <a href="uts-creations.html" class="mobile-nav-link mobile-nav-sublink">UTS Creations</a>
            <a href="east-coast-simulations.html" class="mobile-nav-link mobile-nav-sublink">East Coast Simulations</a>
            <a href="virtual-rail-creations.html" class="mobile-nav-link mobile-nav-sublink">Virtual Rail Creations</a>
        </div>
    </nav>
    
    <div class="privacy-main-wide">
        <div class="privacy-container">
            <div class="contributor-page-section">
                <!-- Breadcrumb -->
                <div class="text-gray-400 mb-2">
                    <a href="index.html" class="hover:underline">Home</a> &gt;
                    <span>Search</span>
                </div>
                
                <!-- Search Header -->
                <div class="contributor-header">
                    <h1>Search Results</h1>
                    <p class="contributor-description" id="searchQueryDisplay"></p>
                </div>
                
                <div id="searchSuggestion"></div>
                
                <!-- Search Results -->
                <div id="searchResults" class="category-section">
                    <div class="search-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Searching...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer id="dynamicFooter">
        <div class="footer-content">
            <div class="footer-nav">
                <a href="terms.html">Terms of Use</a>
                <span class="separator">•</span>
                <a href="privacy.html">Privacy Policy</a>
                <span class="separator">•</span>
                <a href="support.html">Support Us</a>
                <span class="separator">•</span>
                <a href="https://www.facebook.com/groups/trainsimulatormodarchive" target="_blank" title="Facebook Group">
                    <i class="fab fa-facebook"></i>
                </a>
            </div>
            <p class="footer-copyright">&copy; 2023 - 2025 Train Simulator Mod Archive</p>
        </div>
    </footer>

    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/main.js"></script>
    <script>
        // Clear old cached search data to ensure fresh results
        try {
            // Clear sessionStorage cache for old mods
            sessionStorage.removeItem('lastShownMods');
            sessionStorage.removeItem('cachedSearchResults');
            sessionStorage.removeItem('searchCache');
            
            // Clear localStorage cache for old data
            localStorage.removeItem('searchCache');
            localStorage.removeItem('modsCache');
        } catch (e) {
            console.warn('Could not clear cache:', e);
        }
        
        // Get search query from URL
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get('q');
        
        // Display search query
        const queryDisplay = document.getElementById('searchQueryDisplay');
        if (query) {
            queryDisplay.textContent = `Showing results for: "${query}"`;
        } else {
            queryDisplay.textContent = 'No search query provided';
        }
        
        // Levenshtein distance for fuzzy matching
        function levenshteinDistance(str1, str2) {
            const len1 = str1.length;
            const len2 = str2.length;
            const matrix = [];

            for (let i = 0; i <= len1; i++) {
                matrix[i] = [i];
            }

            for (let j = 0; j <= len2; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= len1; i++) {
                for (let j = 1; j <= len2; j++) {
                    if (str1.charAt(i - 1) === str2.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }

            return matrix[len1][len2];
        }

        // Find closest match from all mods
        async function findClosestMatch(searchQuery) {
            try {
                // Add cache-busting timestamp
                const timestamp = new Date().getTime();
                const response = await fetch(`https://api.trainsimarchive.org/api/random-mods?count=999&_=${timestamp}`);
                const data = await response.json();
                
                data.mods.forEach(mod => {
                    const titleLower = mod.title.toLowerCase();
                    const distance = levenshteinDistance(queryLower, titleLower);
                    
                    // Also check word-by-word
                    const queryWords = queryLower.split(/\s+/);
                    const titleWords = titleLower.split(/\s+/);
                    
                    queryWords.forEach(qWord => {
                        titleWords.forEach(tWord => {
                            const wordDistance = levenshteinDistance(qWord, tWord);
                            if (wordDistance < distance && wordDistance < smallestDistance) {
                                if (wordDistance <= 2 && qWord.length > 3) {
                                    closestMatch = mod;
                                    smallestDistance = wordDistance;
                                }
                            }
                        });
                    });
                    
                    if (distance < smallestDistance && distance <= 3 && searchQuery.length > 4) {
                        closestMatch = mod;
                        smallestDistance = distance;
                    }
                });
                
                return closestMatch;
            } catch (error) {
                console.error('Error finding closest match:', error);
                return null;
            }
        }

        // Perform search
        async function performSearch(searchQuery) {
            const resultsContainer = document.getElementById('searchResults');
            const suggestionContainer = document.getElementById('searchSuggestion');
            
            if (!searchQuery || searchQuery.trim() === '') {
                resultsContainer.innerHTML = '<p class="search-no-results">Please enter a search term.</p>';
                return;
            }
            
            try {
                // Add cache-busting timestamp to force fresh API calls
                const timestamp = new Date().getTime();
                const response = await fetch(`https://api.trainsimarchive.org/api/search?q=${encodeURIComponent(searchQuery)}&_=${timestamp}`);
                const data = await response.json();
                
                if (data.error) {
                    console.error('API error:', data.error);
                    resultsContainer.innerHTML = `<p class="search-error">Error: ${data.error}</p>`;
                    return;
                }
                
                if (!data.results || data.results.length === 0) {
                    // Try to find a close match
                    const closestMatch = await findClosestMatch(searchQuery);
                    
                    if (closestMatch) {
                        suggestionContainer.innerHTML = `
                            <div class="search-suggestion">
                                <i class="fas fa-lightbulb"></i>
                                <span>Did you mean:</span> 
                                <a href="?q=${encodeURIComponent(closestMatch.title)}">${closestMatch.title}</a>
                            </div>
                        `;
                    }
                    
                    resultsContainer.innerHTML = `
                        <h2 class="category-title">Found 0 Results</h2>
                        <div class="search-no-results">
                            <i class="fas fa-search" style="font-size: 48px; color: #666; margin-bottom: 1rem;"></i>
                            <h3>No results found</h3>
                            <p>Try different keywords or browse the <a href="trurail-simulations.html">archive</a>.</p>
                        </div>
                    `;
                    return;
                }
                
                suggestionContainer.innerHTML = '';
                
                // Display results - add results as a new section
                resultsContainer.innerHTML = `
                    <h2 class="category-title">Found ${data.totalResults} Result${data.totalResults === 1 ? '' : 's'}</h2>
                    <div class="mods-grid search-results-grid">
                        ${data.results.map(mod => `
                            <div class="mod-card">
                                <a href="${mod.url}" class="mod-card-link">
                                    <div class="mod-card-image" style="background-image: url('${mod.image}');"></div>
                                </a>
                                <div class="mod-card-content">
                                    <a href="${mod.url}" class="mod-card-link">
                                        <h3 class="mod-card-title">${mod.title}</h3>
                                    </a>
                                    <p class="mod-card-description">${mod.description}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
            } catch (error) {
                console.error('Search error:', error);
                resultsContainer.innerHTML = `<p class="search-error">An error occurred while searching. Please try again later.</p>`;
            }
        }
        
        // Execute search when page loads
        if (query) {
            performSearch(query);
        } else {
            document.getElementById('searchResults').innerHTML = '<p class="search-no-results">Please enter a search term.</p>';
        }
        
        // Update search inputs with current query
        if (query) {
            const desktopInput = document.getElementById('searchInput');
            const mobileInput = document.getElementById('mobileSearchInput');
            if (desktopInput) desktopInput.value = query;
            if (mobileInput) mobileInput.value = query;
        }
    </script>
</body>
</html>
